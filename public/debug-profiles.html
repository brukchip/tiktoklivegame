<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Picture Debug Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .tool-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #FFD700;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .input-group input, .input-group select {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-debug {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .btn-test {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-card h3 {
            margin-bottom: 15px;
            color: #4CAF50;
        }

        .result-card.error h3 {
            color: #F44336;
        }

        .result-card.warning h3 {
            color: #FF9800;
        }

        .data-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .data-display pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .profile-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #FFD700;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .profile-url {
            font-size: 0.8em;
            opacity: 0.8;
            word-break: break-all;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-success {
            background: #4CAF50;
        }

        .status-error {
            background: #F44336;
        }

        .status-warning {
            background: #FF9800;
        }

        .loading {
            text-align: center;
            padding: 20px;
            opacity: 0.8;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Profile Picture Debug Tool</h1>
            <p>Deep analysis and testing of TikTok profile picture capture system</p>
        </div>

        <!-- Session Event Inspector -->
        <div class="tool-section">
            <h2 class="section-title">üì° Session Event Inspector</h2>
            <p>Inspect raw TikTok event data to see what profile information is being captured</p>
            
            <div class="input-group">
                <label for="sessionSelect">Select Session:</label>
                <select id="sessionSelect">
                    <option value="">Loading sessions...</option>
                </select>
            </div>
            
            <button class="btn btn-debug" onclick="inspectSessionEvents()">üîç Inspect Events</button>
            <button class="btn" onclick="loadSessions()">üîÑ Refresh Sessions</button>
            
            <div id="sessionResults"></div>
        </div>

        <!-- Profile Source Tester -->
        <div class="tool-section">
            <h2 class="section-title">üß™ Profile Source Tester</h2>
            <p>Test all available sources for profile pictures for a specific username</p>
            
            <div class="input-group">
                <label for="testUsername">Username to Test:</label>
                <input type="text" id="testUsername" placeholder="Enter TikTok username (without @)">
            </div>
            
            <button class="btn btn-test" onclick="testProfileSources()">üß™ Test All Sources</button>
            
            <div id="profileResults"></div>
        </div>

        <!-- Gaming System Status -->
        <div class="tool-section">
            <h2 class="section-title">üéÆ Gaming System Status</h2>
            <p>Check current game status and profile picture capture statistics</p>
            
            <div class="input-group">
                <label for="gameSessionSelect">Select Game Session:</label>
                <select id="gameSessionSelect">
                    <option value="">Select a session...</option>
                </select>
            </div>
            
            <button class="btn" onclick="checkGameStatus()">üìä Check Game Status</button>
            
            <div id="gameResults"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        
        // Load sessions on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadSessions();
        });

        async function loadSessions() {
            try {
                const response = await fetch(`${API_BASE}/sessions`);
                const data = await response.json();
                
                const sessionSelect = document.getElementById('sessionSelect');
                const gameSessionSelect = document.getElementById('gameSessionSelect');
                
                sessionSelect.innerHTML = '<option value="">Select a session...</option>';
                gameSessionSelect.innerHTML = '<option value="">Select a session...</option>';
                
                if (data.sessions && data.sessions.length > 0) {
                    data.sessions.forEach(session => {
                        const statusIcon = session.isActive ? 'üü¢' : 'üî¥';
                        const optionText = `${statusIcon} @${session.streamer_username} (${session.total_events} events)`;
                        
                        const option1 = new Option(optionText, session.id);
                        const option2 = new Option(optionText, session.id);
                        
                        sessionSelect.appendChild(option1);
                        gameSessionSelect.appendChild(option2);
                    });
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        async function inspectSessionEvents() {
            const sessionId = document.getElementById('sessionSelect').value;
            if (!sessionId) {
                alert('Please select a session first');
                return;
            }
            
            const resultsDiv = document.getElementById('sessionResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div> Inspecting session events...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/debug/session/${sessionId}/events/raw?limit=20`);
                const data = await response.json();
                
                if (data.success) {
                    resultsDiv.innerHTML = `
                        <div class="results-grid">
                            <div class="result-card">
                                <h3>üìä Session Statistics</h3>
                                <p><strong>Total Chat Events:</strong> ${data.totalChatEvents}</p>
                                <p><strong>Recent Events:</strong> ${data.recentEvents.length}</p>
                                <p><strong>Session ID:</strong> ${data.sessionId}</p>
                            </div>
                            
                            <div class="result-card">
                                <h3>üè† Room Info</h3>
                                <div class="data-display">
                                    <pre>${JSON.stringify(data.sessionRoomInfo, null, 2)}</pre>
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="margin: 20px 0; color: #FFD700;">üìù Recent Chat Events</h3>
                        ${data.recentEvents.map(event => `
                            <div class="result-card">
                                <div class="profile-preview">
                                    <div class="profile-avatar">
                                        ${event.userProfile?.profilePicture || event.userProfile?.profilePictureLarge ? 
                                            `<img src="${event.userProfile.profilePicture || event.userProfile.profilePictureLarge}" alt="${event.username}">` : 
                                            event.username.substring(0, 2).toUpperCase()
                                        }
                                    </div>
                                    <div class="profile-info">
                                        <div class="profile-name">@${event.username}</div>
                                        <div class="profile-url">${event.message}</div>
                                        <div style="margin-top: 5px;">
                                            <span class="status-badge ${event.userProfile?.profilePicture ? 'status-success' : 'status-error'}">
                                                ${event.userProfile?.profilePicture ? 'Has Profile' : 'No Profile'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; font-weight: bold;">üì± User Profile Data</summary>
                                    <div class="data-display">
                                        <pre>${JSON.stringify(event.userProfile, null, 2)}</pre>
                                    </div>
                                </details>
                                
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: bold;">üîß Raw User Data</summary>
                                    <div class="data-display">
                                        <pre>${JSON.stringify(event.rawUser, null, 2)}</pre>
                                    </div>
                                </details>
                            </div>
                        `).join('')}
                    `;
                } else {
                    resultsDiv.innerHTML = `<div class="result-card error"><h3>‚ùå Error</h3><p>${data.error}</p></div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result-card error"><h3>‚ùå Error</h3><p>${error.message}</p></div>`;
            }
        }

        async function testProfileSources() {
            const username = document.getElementById('testUsername').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            const resultsDiv = document.getElementById('profileResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div> Testing profile sources...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/debug/profile-test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await response.json();
                
                if (data.success) {
                    const results = data.results;
                    
                    resultsDiv.innerHTML = `
                        <h3 style="margin: 20px 0; color: #FFD700;">üîç Profile Sources for @${username}</h3>
                        <div class="results-grid">
                            <div class="result-card ${results.activeSession?.found ? '' : 'error'}">
                                <h3>üì° Active Session</h3>
                                ${results.activeSession?.found ? `
                                    <div class="profile-preview">
                                        <div class="profile-avatar">
                                            ${results.activeSession.userProfile?.profilePicture ? 
                                                `<img src="${results.activeSession.userProfile.profilePicture}" alt="${username}">` : 
                                                username.substring(0, 2).toUpperCase()
                                            }
                                        </div>
                                        <div class="profile-info">
                                            <div class="profile-name">Found in Session</div>
                                            <div class="profile-url">Events: ${results.activeSession.eventCount}</div>
                                        </div>
                                    </div>
                                    <div class="data-display">
                                        <pre>${JSON.stringify(results.activeSession.userProfile, null, 2)}</pre>
                                    </div>
                                ` : '<p>‚ùå Not found in active sessions</p>'}
                            </div>
                            
                            <div class="result-card ${results.directAPI?.found ? '' : 'error'}">
                                <h3>üîó Direct TikTok API</h3>
                                ${results.directAPI?.found ? `
                                    <div class="profile-preview">
                                        <div class="profile-avatar">
                                            ${results.directAPI.owner?.avatarLarger ? 
                                                `<img src="${results.directAPI.owner.avatarLarger}" alt="${username}">` : 
                                                username.substring(0, 2).toUpperCase()
                                            }
                                        </div>
                                        <div class="profile-info">
                                            <div class="profile-name">${results.directAPI.owner?.displayName || username}</div>
                                            <div class="profile-url">Direct API Call</div>
                                        </div>
                                    </div>
                                    <div class="data-display">
                                        <pre>${JSON.stringify(results.directAPI.owner, null, 2)}</pre>
                                    </div>
                                ` : `<p>‚ùå ${results.directAPI?.error || 'Not found via direct API'}</p>`}
                            </div>
                            
                            <div class="result-card ${results.database?.found ? '' : 'warning'}">
                                <h3>üíæ Database</h3>
                                ${results.database?.found ? `
                                    <div class="profile-preview">
                                        <div class="profile-avatar">
                                            ${results.database.data?.profileImage ? 
                                                `<img src="${results.database.data.profileImage}" alt="${username}">` : 
                                                username.substring(0, 2).toUpperCase()
                                            }
                                        </div>
                                        <div class="profile-info">
                                            <div class="profile-name">${results.database.data?.displayName || username}</div>
                                            <div class="profile-url">Stored in Database</div>
                                        </div>
                                    </div>
                                    <div class="data-display">
                                        <pre>${JSON.stringify(results.database.data, null, 2)}</pre>
                                    </div>
                                ` : '<p>‚ö†Ô∏è Not found in database</p>'}
                            </div>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `<div class="result-card error"><h3>‚ùå Error</h3><p>${data.error}</p></div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result-card error"><h3>‚ùå Error</h3><p>${error.message}</p></div>`;
            }
        }

        async function checkGameStatus() {
            const sessionId = document.getElementById('gameSessionSelect').value;
            if (!sessionId) {
                alert('Please select a session first');
                return;
            }
            
            const resultsDiv = document.getElementById('gameResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div> Checking game status...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/gaming/status/${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    const status = data.status;
                    
                    resultsDiv.innerHTML = `
                        <div class="results-grid">
                            <div class="result-card">
                                <h3>üéÆ Game Status</h3>
                                <p><strong>Active:</strong> ${status.active ? 'Yes' : 'No'}</p>
                                <p><strong>Type:</strong> ${status.type || 'None'}</p>
                                <p><strong>Status:</strong> ${status.status || 'None'}</p>
                                <p><strong>Time Remaining:</strong> ${status.timeRemainingSeconds || 0}s</p>
                            </div>
                            
                            <div class="result-card">
                                <h3>üìä Profile Statistics</h3>
                                ${status.profileStats ? `
                                    <p><strong>Total Entries:</strong> ${status.profileStats.totalEntries}</p>
                                    <p><strong>With Profiles:</strong> ${status.profileStats.withProfiles}</p>
                                    <p><strong>Without Profiles:</strong> ${status.profileStats.withoutProfiles}</p>
                                    <p><strong>Success Rate:</strong> ${status.profileStats.totalEntries ? Math.round((status.profileStats.withProfiles / status.profileStats.totalEntries) * 100) : 0}%</p>
                                ` : '<p>No active game</p>'}
                            </div>
                        </div>
                        
                        ${status.entries && status.entries.length > 0 ? `
                            <h3 style="margin: 20px 0; color: #FFD700;">üéØ Game Entries</h3>
                            ${status.entries.map(entry => `
                                <div class="result-card">
                                    <div class="profile-preview">
                                        <div class="profile-avatar">
                                            ${entry.profilePicture && entry.hasValidProfile ? 
                                                `<img src="${entry.profilePicture}" alt="${entry.username}">` : 
                                                entry.username.substring(0, 2).toUpperCase()
                                            }
                                        </div>
                                        <div class="profile-info">
                                            <div class="profile-name">@${entry.username}</div>
                                            <div class="profile-url">${entry.message}</div>
                                            <div style="margin-top: 5px;">
                                                <span class="status-badge ${entry.hasValidProfile ? 'status-success' : 'status-error'}">
                                                    ${entry.hasValidProfile ? 'Valid Profile' : 'No Profile'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    ${entry.profilePicture ? `
                                        <div class="data-display">
                                            <strong>Profile URL:</strong><br>
                                            <code>${entry.profilePicture}</code>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        ` : ''}
                    `;
                } else {
                    resultsDiv.innerHTML = `<div class="result-card error"><h3>‚ùå Error</h3><p>${data.error}</p></div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result-card error"><h3>‚ùå Error</h3><p>${error.message}</p></div>`;
            }
        }
    </script>
</body>
</html>
